<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Rekap Permintaan Lampu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
  <style>
    body { background: #f6f7fb; font-family: Arial, sans-serif; }
    .brand-bar { background:#61b3f1; box-shadow: inset 0 -1px 0 rgba(0,0,0,.1); }
    .brand { font-weight:800; letter-spacing:.5px; color:#fff; font-size:26px; }
    .pill-nav a{
      display:inline-block; padding:10px 24px; border-radius:999px; background:#1f4c6b;
      color:#fff; text-decoration:none; font-weight:600; margin-left:14px; transition:all .3s ease;
    }
    .pill-nav a:hover{ filter:brightness(1.15); transform:scale(1.05); }

    .card-box{
      background:#fff; border-radius:28px; box-shadow:0 12px 38px rgba(0,0,0,.06);
      border:1px solid rgba(0,0,0,.05); padding:30px; transition:transform .3s, box-shadow .3s;
    }
    .card-box:hover{ transform:translateY(-5px); box-shadow:0 16px 38px rgba(0,0,0,.1); }

    .summary-box{ background:#fff; border-radius:20px; padding:20px; text-align:center;
      box-shadow:0 4px 12px rgba(0,0,0,.05); transition:transform .3s, box-shadow .3s; }
    .summary-box:hover{ transform:translateY(-5px); box-shadow:0 6px 20px rgba(0,0,0,.1); }

    .custom-table{
      border-collapse:separate; border-spacing:0; width:100%; border:2px solid #000;
      border-radius:15px; overflow:hidden;
    }
    .custom-table th{ background:#1c3d99; color:#fff; text-align:center; font-weight:700; border:1px solid #000; }
    .custom-table td{ text-align:center; border:1px solid #000; background:#fff; vertical-align:middle; }
    .custom-table tbody tr{ transition:transform .3s, box-shadow .3s; }
    .custom-table tbody tr:hover{ transform:scale(1.03); box-shadow:0 4px 12px rgba(0,0,0,.12); position:relative; z-index:1; }

    .btn-info, .btn-danger, .btn-outline-primary{ transition:all .3s ease; }
    .btn-info:hover, .btn-danger:hover, .btn-outline-primary:hover{ transform:scale(1.05); }
  </style>
</head>
<body>

  <div class="brand-bar py-3">
    <div class="container d-flex justify-content-between align-items-center">
      <div class="brand">Prediksi Lampu</div>
      <div class="pill-nav">
        <a href="/">Beranda</a>
        <a href="/rekap" class="active">Rekap</a>
      </div>
    </div>
  </div>

  <div class="container my-5">

    <!-- Summary -->
    <div class="row g-4 mb-4">
      <div class="col-md-3 animate__animated animate__fadeInUp animate__delay-1s">
        <div class="summary-box">
          <div>Jumlah Tahun</div>
          <h5>{{ rekap_tahunan|length }}</h5>
        </div>
      </div>
      <div class="col-md-3 animate__animated animate__fadeInUp animate__delay-2s">
        <div class="summary-box">
          <div>Total LED</div>
          <h5>{{ rekap_tahunan | sum(attribute='LED') }}</h5>
        </div>
      </div>
      <div class="col-md-3 animate__animated animate__fadeInUp animate__delay-3s">
        <div class="summary-box">
          <div>Total HID</div>
          <h5>{{ rekap_tahunan | sum(attribute='HID') }}</h5>
        </div>
      </div>
      <div class="col-md-3 animate__animated animate__fadeInUp animate__delay-4s">
        <div class="summary-box">
          <div>Total Bohlam</div>
          <h5>{{ rekap_tahunan | sum(attribute='Bohlam') }}</h5>
        </div>
      </div>
    </div>

    <!-- Rekap Tahunan -->
    <div class="card-box animate__animated animate__fadeInUp animate__delay-1s">
      <h4 class="text-center mb-4">Rekap Permintaan Tahunan</h4>
      <div class="table-responsive">
        <table class="custom-table">
          <thead>
            <tr>
              <th>Tahun</th>
              <th>LED</th>
              <th>HID</th>
              <th>Bohlam</th>
              <th>Total</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody>
            {% for row in rekap_tahunan %}
            {% set tahun = row.Tahun|int %}
            <tr class="animate__animated animate__fadeInUp animate__faster" data-delay="{{ (loop.index0 * 0.1) | round(1) }}">
              <td>{{ tahun }}</td>
              <td>{{ "{:,}".format(row.LED) }}</td>
              <td>{{ "{:,}".format(row.HID) }}</td>
              <td>{{ "{:,}".format(row.Bohlam) }}</td>
              <td><strong>{{ "{:,}".format(row.Total) }}</strong></td>
              <td>
                <!-- SELALU tampilkan View -->
                <a href="/view/{{ tahun }}" class="btn btn-info btn-sm">View</a>
                <form method="POST" action="/hapus/{{ tahun }}" style="display:inline-block;"
                      onsubmit="return confirm('Yakin ingin menghapus tahun {{ tahun }}?')">
                  <button type="submit" class="btn btn-danger btn-sm">Hapus</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Grafik Tren Tahunan -->
    <div class="text-center mt-5 animate__animated animate__fadeInUp animate__delay-2s">
      <img src="{{ url_for('static', filename='tren_permintaan_tahunan.png') }}" class="img-fluid mt-3" style="max-width:90%;height:auto;">
    </div>

    <!-- Histori: Dipisah per Tahun -->
    {% if histori_per_tahun %}
      {% for group in histori_per_tahun %}
      <div class="card-box mt-5 animate__animated animate__fadeInUp animate__delay-3s">
        <h5 class="text-center mb-3">Histori Prediksi Tahun {{ group.tahun }}</h5>
        <div class="table-responsive">
          <table class="custom-table">
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>Waktu</th>
                <th>Bulan</th>
                <th>Tahun</th>
                <th>LED</th>
                <th>HID</th>
                <th>Bohlam</th>
              </tr>
            </thead>
            <tbody>
              {% for row in group.rows %}
              <tr>
                <td>{{ row.Tanggal }}</td>
                <td>{{ row.Waktu }}</td>
                <td>{{ row.Bulan }}</td>
                <td>{{ row.Tahun }}</td>
                <td>{{ "{:,}".format(row.LED) }}</td>
                <td>{{ "{:,}".format(row.HID) }}</td>
                <td>{{ "{:,}".format(row.Bohlam) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endfor %}
    {% endif %}

    <!-- Unduh -->
    <div class="text-center my-4 animate__animated animate__fadeInUp animate__delay-4s">
      <a href="/unduh" class="btn btn-outline-primary rounded-pill px-4">Unduh Histori CSV</a>
    </div>
  </div>

  <footer style="background-color:#2c3e50;color:#fff;" class="py-3 mt-auto animate__animated animate__fadeInUp">
    <div class="container text-center">
      &copy; {{ current_year }} Sistem Prediksi Lampu. All Rights Reserved
    </div>
  </footer>

  <script>
    // terapkan delay animasi tanpa mengganggu linter CSS
    document.querySelectorAll('tr[data-delay]').forEach(function (el) {
      var d = el.getAttribute('data-delay');
      if (d) el.style.animationDelay = d + 's';
    });
  </script>
</body>
</html>
