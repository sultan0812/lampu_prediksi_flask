<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Prediksi Permintaan Lampu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
  <style>
    html, body { height: 100%; }
    body {
      display: flex; flex-direction: column; min-height: 100vh; background: #f6f7fb;
    }
    main { flex: 1; }

    .brand-bar { background: #61b3f1; box-shadow: inset 0 -1px 0 rgba(0,0,0,0.1); }
    .brand-bar .brand { font-weight: 800; letter-spacing: .5px; color: #fff; font-size: 26px; }
    .pill-nav a {
      display:inline-block; padding:10px 24px; border-radius:999px; background:#1f4c6b;
      color:#fff; text-decoration:none; font-weight:600; margin-left:14px;
    }
    .pill-nav a.active{ filter:brightness(1.08); }
    .pill-nav a:hover{ filter:brightness(1.15); }

    .card-box {
      background:#fff; border-radius:28px; box-shadow:0 12px 38px rgba(0,0,0,.06);
      border:1px solid rgba(0,0,0,.05); padding:30px; max-width: 900px; margin:auto;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card-box:hover {
      transform: translateY(-6px);
      box-shadow: 0 16px 38px rgba(0, 0, 0, 0.1);
    }
    .card-narrow{ max-width:520px; }
    .section-title{ text-align:center; font-weight:800; font-size:28px; color:#1d2b3a; }
    .table-prediksi th{ background:#2e64ad; color:#fff; text-align:center; }
    .custom-table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      border: 2px solid #000;
      border-radius: 15px;
      overflow: hidden;
    }
    .custom-table th {
      background-color: #1c3d99;
      color: white;
      text-align: center;
      font-weight: bold;
      border: 1px solid #000;
    }
    .custom-table td {
      text-align: center;
      border: 1px solid #000;
      background-color: #fff;
      vertical-align: middle;
    }
    button, .btn {
      transition: all 0.3s ease;
    }
    button:hover {
      transform: scale(1.03);
    }
  </style>
</head>
<body>
  <div class="brand-bar py-3">
    <div class="container d-flex justify-content-between align-items-center">
      <div class="brand">Prediksi Lampu</div>
      <div class="pill-nav">
        <a href="/" class="active">Beranda</a>
        <a href="/rekap">Rekap</a>
      </div>
    </div>
  </div>

  <main class="py-5 animate__animated animate__fadeInUp animate__faster">
    <div class="container">
      <div class="row g-4">
        <div class="col-lg-6">
          <div class="card-box card-narrow h-100 animate__animated animate__fadeInUp animate__delay-1s">
            <h4 class="section-title mb-4">Form Prediksi Permintaan Bulanan</h4>
            <form id="formBulanan" onsubmit="return showAlertBulanan()" method="POST" action="/predict">
              <div class="mb-3">
                <label class="form-label">Bulan</label>
                <select class="form-select" name="month" required>
                  {% for b in ["January","February","March","April","May","June","July","August","September","October","November","December"] %}
                    <option value="{{ b }}" {% if selected_month == b %}selected{% endif %}>{{ b }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Tahun</label>
                <input type="number" class="form-control" name="year"
                       value="{{ selected_year or '' }}" placeholder="contoh: 2027" required>
              </div>
              <div class="d-grid">
                <button class="btn btn-success rounded-pill">Prediksi</button>
              </div>
            </form>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card-box card-narrow h-100 animate__animated animate__fadeInUp animate__delay-2s">
            <h4 class="section-title mb-4">Form Prediksi Permintaan Tahunan</h4>
            <form id="formTahunan" onsubmit="return showAlertTahunan()" method="POST" action="/predict-year">
              <div class="mb-3">
                <label class="form-label">Periode Data (terkunci)</label>
                <input type="text" class="form-control" value="2019 â€“ 2025" disabled>
              </div>
              <div class="mb-3">
                <label class="form-label">Tahun Prediksi</label>
                <input type="number" class="form-control" name="year_predict"
                       value="{{ selected_year_pred or '' }}" placeholder="contoh: 2027" required>
              </div>
              <div class="d-grid">
                <button class="btn btn-success rounded-pill">Prediksi</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      {% if prediction %}
      <div class="card-box mt-5 animate__animated animate__fadeInUp animate__delay-3s">
        <h4 class="section-title">Hasil Prediksi</h4>
        <p class="text-center mb-4">{{ selected_month }} {{ selected_year }}</p>
        <div class="table-responsive">
          <table class="table table-bordered table-prediksi">
            <thead><tr><th>LED</th><th>HID</th><th>Bohlam</th></tr></thead>
            <tbody>
              <tr>
                <td>{{ "{:,}".format(prediction.LED) }} Unit</td>
                <td>{{ "{:,}".format(prediction.HID) }} Unit</td>
                <td>{{ "{:,}".format(prediction.Bohlam) }} Unit</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}

      {% if annual_result %}
      <div class="card-box mt-5 animate__animated animate__fadeInUp animate__delay-3s">
        <h4 class="section-title">Hasil Prediksi Tahunan {{ annual_year }}</h4>
        <div class="table-responsive">
          <table class="custom-table">
            <thead><tr><th>Bulan</th><th>LED</th><th>HID</th><th>Bohlam</th><th>Total</th></tr></thead>
            <tbody>
              {% for r in annual_result %}
              <tr>
                <td>{{ r.Bulan }}</td>
                <td>{{ "{:,}".format(r.LED) }}</td>
                <td>{{ "{:,}".format(r.HID) }}</td>
                <td>{{ "{:,}".format(r.Bohlam) }}</td>
                <td>{{ "{:,}".format(r.Total) }}</td>
              </tr>
              {% endfor %}
              <tr class="table-secondary fw-bold">
                <td>Total {{ annual_year }}</td>
                <td>{{ "{:,}".format(annual_result | sum(attribute='LED')) }}</td>
                <td>{{ "{:,}".format(annual_result | sum(attribute='HID')) }}</td>
                <td>{{ "{:,}".format(annual_result | sum(attribute='Bohlam')) }}</td>
                <td>{{ "{:,}".format(annual_result | sum(attribute='Total')) }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        {% if annual_chart_file %}
        <div class="mt-4 text-center">
          <h5>Grafik Tren Bulanan {{ annual_year }}</h5>
          <img src="{{ url_for('static', filename=('grafik_tahunan_' ~ annual_year ~ '.png')) }}" class="img-fluid mt-2" style="max-width:80%;height:auto;">
        </div>
        {% endif %}
      </div>
      {% endif %}

      {% if grafik_file %}
      <div class="mt-5 text-center animate__animated animate__fadeInUp animate__delay-4s">
        <h5>Grafik Permintaan Histori</h5>
        <img src="{{ url_for('static', filename='grafik_permintaan.png') }}" class="img-fluid mt-3" style="max-width:80%;height:auto;">
      </div>
      {% endif %}

      <div class="text-center my-4">
        <a href="/unduh" class="btn btn-outline-primary rounded-pill px-4">Unduh Histori CSV</a>
      </div>
    </div>
  </main>

  <footer style="background-color:#2c3e50;color:#fff;" class="py-3 mt-auto">
    <div class="container text-center">
      &copy; {{ datetime.now().year }} Sistem Prediksi Lampu. All Rights Reserved
    </div>
  </footer>

<script>
  function showAlertBulanan() {
    Swal.fire({
      title: 'Memproses Prediksi...',
      text: 'Permintaan bulanan sedang diproses!',
      icon: 'info',
      timer: 3000,
      timerProgressBar: true,
      showConfirmButton: false,
      didOpen: () => { Swal.showLoading() },
      willClose: () => {document.getElementById("formBulanan").submit();}
    });
    return false;
  }
  function showAlertTahunan() {
    Swal.fire({
      title: 'Memproses Prediksi...',
      text: 'Prediksi tahunan sedang dihitung!',
      icon: 'info',
      timer: 3000,
      timerProgressBar: true,
      showConfirmButton: false,
      didOpen: () => { Swal.showLoading() },
      willClose: () => {document.getElementById("formTahunan").submit();}
    });
    return false;
  }
</script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const urlParams = new URLSearchParams(window.location.search);
    const successType = urlParams.get('success');

    if (successType === 'bulanan') {
      Swal.fire({
        icon: 'success',
        title: 'Berhasil!',
        text: 'Prediksi bulanan berhasil ditampilkan!',
        showClass: { popup: 'animate__animated animate__fadeInDown' },
        hideClass: { popup: 'animate__animated animate__fadeOutUp' },
        showConfirmButton: false,
        timer: 2500
      });
    } else if (successType === 'tahunan') {
      Swal.fire({
        icon: 'success',
        title: 'Berhasil!',
        text: 'Prediksi tahunan berhasil ditampilkan!',
        showClass: { popup: 'animate__animated animate__fadeInDown' },
        hideClass: { popup: 'animate__animated animate__fadeOutUp' },
        showConfirmButton: false,
        timer: 2500
      });
    }
  });
</script>
</body>
</html>
